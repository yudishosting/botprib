<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Admin Dashboard untuk Mengunggah Musik">
  <title>Admin - Unggah Musik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div class="container max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="glass-effect rounded-2xl p-6 sm:p-8 lg:p-10 relative z-10 fade-in">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl sm:text-4xl font-bold text-white font-['Playfair_Display']">
          <i class="fas fa-upload mr-2 text-yellow-400"></i>
          Unggah Musik Baru
        </h1>
        <a href="/" class="text-gray-300 hover:text-yellow-400 transition-all duration-300">
          <i class="fas fa-home"></i>
          Kembali ke Beranda
        </a>
      </div>

      <div class="card p-6">
        <form id="uploadForm" class="space-y-6">
          <div>
            <label for="songTitle" class="block text-sm font-medium text-gray-300 mb-2">
              Judul Lagu
            </label>
            <input type="text" id="songTitle" name="songTitle" placeholder="Masukkan judul lagu" required class="w-full px-4 py-2 bg-gray-800/50 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400">
          </div>

          <div>
            <label for="artistSelect" class="block text-sm font-medium text-gray-300 mb-2">
              Pilih Artis atau Tambah Baru
            </label>
            <select id="artistSelect" name="artistSelect" required class="w-full px-4 py-2 bg-gray-800/50 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400">
              <option value="">Pilih artis</option>
            </select>
            <input type="text" id="newArtistName" name="newArtistName" placeholder="Masukkan nama artis baru" class="mt-2 hidden w-full px-4 py-2 bg-gray-800/50 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400">
          </div>

          <div>
            <label for="audioFile" class="block text-sm font-medium text-gray-300 mb-2">
              File Audio (MP3, Max 10MB)
            </label>
            <input type="file" id="audioFile" name="audioFile" accept="audio/mpeg,audio/mp3" required class="w-full text-gray-300">
          </div>

          <div>
            <label for="lyricFile" class="block text-sm font-medium text-gray-300 mb-2">
              File Lirik (JS, Opsional)
            </label>
            <input type="file" id="lyricFile" name="lyricFile" accept=".js,text/javascript" class="w-full text-gray-300">
          </div>

          <div>
            <label for="artistPhoto" class="block text-sm font-medium text-gray-300 mb-2">
              Foto Artis (JPG/PNG, Max 2MB, Opsional)
            </label>
            <input type="file" id="artistPhoto" name="artistPhoto" accept="image/jpeg,image/png" class="w-full text-gray-300">
          </div>

          <button type="submit" class="btn w-full flex items-center justify-center">
            <i class="fas fa-upload mr-2"></i>
            Unggah
          </button>
        </form>
      </div>

      <div id="notification" class="notification"></div>
    </div>
  </div>

  <script>
    // Partikel Animasi
    function initParticles() {
      const canvas = document.getElementById('particleCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const particleCount = 50;

      for (let i = 0; i < particleCount; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          radius: Math.random() * 2 + 1,
          speed: Math.random() * 0.5 + 0.2
        });
      }

      function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(250, 204, 21, 0.2)';
          ctx.fill();
          p.y -= p.speed;
          if (p.y < 0) p.y = canvas.height;
        });
        requestAnimationFrame(animateParticles);
      }

      animateParticles();
      window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });
    }

    // Fungsi untuk menampilkan notifikasi
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
    }

    // Load daftar artis ke dropdown
    function loadArtists() {
      const artistSelect = document.getElementById('artistSelect');
      if (!artistSelect) {
        console.error('Elemen artistSelect tidak ditemukan!');
        showNotification('Gagal memuat daftar artis!', 'error');
        return;
      }

      let playlist;
      try {
        playlist = JSON.parse(localStorage.getItem('playlist')) || [];
      } catch (e) {
        console.error('Gagal parse playlist dari localStorage:', e);
        playlist = [];
        localStorage.setItem('playlist', JSON.stringify(playlist));
      }

      const artists = [...new Set(playlist.map(song => song.artist).filter(artist => artist && typeof artist === 'string'))];
      
      artistSelect.innerHTML = '<option value="">Pilih artis</option>';
      artists.forEach(artist => {
        const option = document.createElement('option');
        option.value = artist;
        option.textContent = artist;
        artistSelect.appendChild(option);
      });

      const addNewOption = document.createElement('option');
      addNewOption.value = "new";
      addNewOption.textContent = "Tambah Artis Baru";
      artistSelect.appendChild(addNewOption);

      console.log('Daftar artis dimuat:', artists);
      if (artists.length === 0) {
        showNotification('Tidak ada artis tersedia. Tambahkan artis baru.', 'info');
      }
    }

    // Toggle input artis baru
    function toggleNewArtistInput() {
      const artistSelect = document.getElementById('artistSelect');
      const newArtistInput = document.getElementById('newArtistName');
      if (artistSelect.value === 'new') {
        newArtistInput.classList.remove('hidden');
        newArtistInput.required = true;
      } else {
        newArtistInput.classList.add('hidden');
        newArtistInput.required = false;
        newArtistInput.value = '';
      }
    }

    // Validasi file lirik
    function validateLyricFile(content) {
      try {
        const cleanedContent = content.replace(/window\.lyrics\s*=\s*/, '');
        const lyrics = JSON.parse(cleanedContent.match(/\[.*\]/s)?.[0] || '[]');
        return Array.isArray(lyrics) && lyrics.every(line => 
          line && typeof line === 'object' && 
          typeof line.time === 'number' && 
          typeof line.text === 'string'
        );
      } catch (e) {
        console.error('Gagal memvalidasi file lirik:', e);
        return false;
      }
    }

    // Validasi ukuran file
    function validateFileSize(file, maxSizeMB, fileType) {
      const maxSizeBytes = maxSizeMB * 1024 * 1024;
      if (file.size > maxSizeBytes) {
        showNotification(`${fileType} melebihi ukuran maksimum ${maxSizeMB}MB!`, 'error');
        return false;
      }
      return true;
    }

    // Sanitasi nama file
    function sanitizeFileName(name) {
      return name
        .toLowerCase()
        .replace(/[^a-z0-9]/g, '')
        .replace(/\s+/g, '');
    }

    // Fungsi untuk mengunggah dan menyimpan metadata
    function handleUpload(event) {
      event.preventDefault();

      const songTitle = document.getElementById('songTitle').value.trim();
      const artistSelect = document.getElementById('artistSelect').value;
      const newArtistName = document.getElementById('newArtistName').value.trim();
      const audioFile = document.getElementById('audioFile').files[0];
      const lyricFile = document.getElementById('lyricFile').files[0];
      const artistPhoto = document.getElementById('artistPhoto').files[0];

      // Validasi input
      if (!songTitle) {
        showNotification('Judul lagu harus diisi!', 'error');
        return;
      }
      if (!artistSelect || (artistSelect === 'new' && !newArtistName)) {
        showNotification('Pilih artis atau masukkan nama artis baru!', 'error');
        return;
      }
      if (!audioFile) {
        showNotification('File audio harus diunggah!', 'error');
        return;
      }
      if (audioFile.type !== 'audio/mpeg' && audioFile.type !== 'audio/mp3') {
        showNotification('File audio harus berformat MP3!', 'error');
        return;
      }
      if (!validateFileSize(audioFile, 10, 'File audio')) {
        return;
      }
      if (artistPhoto && !['image/jpeg', 'image/png'].includes(artistPhoto.type)) {
        showNotification('Foto artis harus berformat JPG atau PNG!', 'error');
        return;
      }
      if (artistPhoto && !validateFileSize(artistPhoto, 2, 'Foto artis')) {
        return;
      }
      if (lyricFile && !['application/javascript', 'text/javascript'].includes(lyricFile.type)) {
        showNotification('File lirik harus berformat JS!', 'error');
        return;
      }
      if (lyricFile && !validateFileSize(lyricFile, 1, 'File lirik')) {
        return;
      }

      // Tentukan nama artis
      const artistName = artistSelect === 'new' ? newArtistName : artistSelect;
      const sanitizedArtist = sanitizeFileName(artistName);
      const sanitizedTitle = sanitizeFileName(songTitle);

      // Simulasi path file
      const audioPath = `music/${sanitizedArtist}/${sanitizedTitle}.mp3`;
      const lyricPath = lyricFile ? `lyrics/${sanitizedArtist}/${sanitizedTitle}.js` : '';
      const photoPath = artistPhoto ? `images/${sanitizedArtist}/${sanitizedArtist}.jpg` : '';

      // Baca file lirik (jika ada)
      const processLyric = lyricFile ? new Promise((resolve, reject) => {
        const lyricReader = new FileReader();
        lyricReader.onload = function(e) {
          const lyricContent = e.target.result;
          if (validateLyricFile(lyricContent)) {
            resolve(lyricPath);
          } else {
            reject('Format lirik tidak valid! Pastikan format: window.lyrics = [{ time: number, text: string }, ...]');
          }
        };
        lyricReader.onerror = () => reject('Gagal membaca file lirik!');
        lyricReader.readAsText(lyricFile);
      }) : Promise.resolve(lyricPath);

      // Baca foto artis (jika ada)
      const processPhoto = artistPhoto ? new Promise((resolve, reject) => {
        const photoReader = new FileReader();
        photoReader.onload = function(e) {
          resolve(photoPath);
        };
        photoReader.onerror = () => reject('Gagal membaca foto artis!');
        photoReader.readAsDataURL(artistPhoto);
      }) : Promise.resolve(photoPath);

      // Proses upload ke server (simulasi)
      Promise.all([processLyric, processPhoto]).then(([lyricPath, photoPath]) => {
        let playlist;
        try {
          playlist = JSON.parse(localStorage.getItem('playlist')) || [];
        } catch (e) {
          console.error('Gagal parse playlist dari localStorage:', e);
          playlist = [];
        }

        // Tambah metadata lagu baru
        const newSong = {
          artist: artistName,
          title: songTitle,
          mp3: audioPath,
          lyric: lyricPath,
          artistPhoto: photoPath || playlist.find(song => song.artist === artistName)?.artistPhoto || ''
        };

        // Validasi ukuran localStorage
        const currentStorageSize = new Blob([JSON.stringify([...playlist, newSong])]).size;
        const maxStorageSize = 5 * 1024 * 1024; // 5MB
        if (currentStorageSize > maxStorageSize) {
          showNotification('Penyimpanan metadata penuh! Hapus beberapa lagu.', 'error');
          return;
        }

        // Simulasi upload file ke folder (di Vercel harus pakai serverless function)
        const formData = new FormData();
        formData.append('audio', audioFile, `${sanitizedTitle}.mp3`);
        if (lyricFile) formData.append('lyric', lyricFile, `${sanitizedTitle}.js`);
        if (artistPhoto) formData.append('photo', artistPhoto, `${sanitizedArtist}.jpg`);

        fetch('/api/upload', {
          method: 'POST',
          body: formData
        }).then(response => {
          if (!response.ok) {
            throw new Error('Gagal mengunggah file ke server!');
          }
          return response.json();
        }).then(() => {
          // Tambah ke playlist dan simpan ke localStorage
          playlist.push(newSong);
          try {
            localStorage.setItem('playlist', JSON.stringify(playlist));
            console.log('Playlist setelah upload:', playlist);
            showNotification('Lagu berhasil diunggah!', 'success');
            document.getElementById('uploadForm').reset();
            toggleNewArtistInput();
            loadArtists();
          } catch (e) {
            console.error('Gagal menyimpan playlist ke localStorage:', e);
            showNotification('Gagal menyimpan metadata lagu!', 'error');
          }
        }).catch(error => {
          console.error('Error saat upload:', error);
          showNotification(error.message, 'error');
        });
      }).catch(error => {
        console.error('Error saat upload:', error);
        showNotification(error, 'error');
      });
    }

    // Inisialisasi
    document.addEventListener('DOMContentLoaded', () => {
      initParticles();
      loadArtists();
      document.getElementById('artistSelect').addEventListener('change', toggleNewArtistInput);
      document.getElementById('uploadForm').addEventListener('submit', handleUpload);

      // Debug: Cek isi localStorage dan input file
      console.log('Isi localStorage playlist:', JSON.parse(localStorage.getItem('playlist')));
      const audioInput = document.getElementById('audioFile');
      audioInput.addEventListener('change', (e) => {
        console.log('File audio dipilih:', e.target.files[0]?.name, e.target.files[0]?.size, 'bytes');
      });
      const lyricInput = document.getElementById('lyricFile');
      lyricInput.addEventListener('change', (e) => {
        console.log('File lirik dipilih:', e.target.files[0]?.name, e.target.files[0]?.size, 'bytes');
      });
      const photoInput = document.getElementById('artistPhoto');
      photoInput.addEventListener('change', (e) => {
        console.log('Foto artis dipilih:', e.target.files[0]?.name, e.target.files[0]?.size, 'bytes');
      });
    });
  </script>
</body>
</html>