<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Playlist musik favorit dengan pengalaman premium">
  <title>Playlist Musik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div id="mainContent" class="container max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="glass-effect rounded-xl p-6 sm:p-8 relative z-10">
      <div id="startPrompt" class="start-prompt text-lg sm:text-xl mb-6 fade-in">
        Jelajahi Koleksi Musik
      </div>

      <button id="backButton" class="hidden mb-6 px-4 py-2 bg-yellow-200 text-gray-900 rounded-lg hover:bg-yellow-100 transition-all duration-300 font-medium text-sm">
        <i class="fas fa-arrow-left mr-2"></i>
        Kembali
      </button>

      <div id="artistList" class="grid-responsive"></div>

      <div id="playlist" class="hidden"></div>

      <audio id="audioPlayer" preload="auto" class="hidden"></audio>

      <div id="musicControls" class="hidden mt-6">
        <div class="glass-effect rounded-xl p-6">
          <div id="nowPlaying" class="text-base font-medium now-playing-text mb-4"></div>
          
          <div class="progress-container mb-4" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          
          <div class="flex justify-between text-sm text-gray-300 mb-4">
            <span id="currentTime">0:00</span>
            <span id="duration">0:00</span>
          </div>

          <div class="flex items-center justify-center space-x-4">
            <button onclick="playPreviousSong()" class="control-btn w-10 h-10 text-white flex items-center justify-center">
              <i class="fas fa-step-backward text-base"></i>
            </button>
            
            <button id="playPauseBtn" onclick="togglePlayPause()" class="control-btn w-12 h-12 text-white flex items-center justify-center text-lg">
              <i id="playPauseIcon" class="fas fa-play"></i>
            </button>
            
            <button onclick="playNextSongManual()" class="control-btn w-10 h-10 text-white flex items-center justify-center">
              <i class="fas fa-step-forward text-base"></i>
            </button>

            <div class="volume-container">
              <i class="fas fa-volume-up text-gray-300"></i>
              <input type="range" min="0" max="1" step="0.01" value="1" class="volume-slider" id="volumeSlider">
            </div>
          </div>
        </div>
      </div>

      <div id="lyrics" class="hidden mt-6 p-6 glass-effect rounded-xl text-white text-base max-h-80 overflow-y-auto"></div>

      <footer class="mt-8 glass-effect rounded-xl p-4 flex justify-center space-x-4">
        <a href="https://instagram.com/yudis_299" target="_blank" class="contact-btn">
          <i class="fab fa-instagram text-base"></i>
          <span class="contact-label">Instagram</span>
        </a>
        <a href="https://wa.me/6285124039070" target="_blank" class="contact-btn">
          <i class="fab fa-whatsapp text-base"></i>
          <span class="contact-label">WhatsApp</span>
        </a>
      </footer>
    </div>
  </div>

  <script>
    // Playlist dari localStorage
    let playlist = JSON.parse(localStorage.getItem('playlist')) || [
      {
        artist: "Nadhif Basalamah",
        title: "Bergema Sampai Selamanya",
        mp3: "music/random/bergema.mp3",
        lyric: "lyrics/random/bergema.js",
        artistPhoto: "/images/random/random.jpg"
      },
      {
        artist: "Nadhif Basalamah",
        title: "Penjaga Hati",
        mp3: "music/random/penjagahati.mp3",
        lyric: "lyrics/random/penjagahati.js",
        artistPhoto: "/images/random/random.jpg"
      },
      {
        artist: "Kendis",
        title: "ours to keep",
        mp3: "music/random/keep.mp3",
        lyric: "lyrics/random/keep.js",
        artistPhoto: "/images/random/random.jpg"
      },
      {
        artist: "Matty Healy",
        title: "About You",
        mp3: "music/random/aboutyou.mp3",
        lyric: "lyrics/random/aboutyou.js",
        artistPhoto: "/images/random/random.jpg"
      },
      {
        artist: "Dougy Mandagi",
        title: "Sweet disposition",
        mp3: "music/random/disposition.mp3",
        lyric: "lyrics/random/disposition.js",
        artistPhoto: "/images/random/random.jpg"
      },
      {
        artist: "One direction",
        title: "where we are",
        mp3: "music/random/weare.mp3",
        lyric: "lyrics/random/weare.js",
        artistPhoto: "/images/random/random.jpg"
      },
      {
        artist: "Aris Lesmana",
        title: "Mangu",
        mp3: "music/random/mangu.mp3",
        lyric: "lyrics/random/mangu.js",
        artistPhoto: "/images/random/random.jpg"
      },
      {
        artist: "Hindia",
        title: "Everything U Are",
        mp3: "music/hindia/everything.mp3",
        lyric: "lyrics/hindia/everything.js",
        artistPhoto: "/images/hindia/hindia.jpg"
      },
      {
        artist: "Hindia",
        title: "Ramai Sepi Bersama",
        mp3: "music/hindia/bersama.mp3",
        lyric: "lyrics/hindia/bersama.js",
        artistPhoto: "/images/hindia/hindia.jpg"
      },
      {
        artist: "Hindia",
        title: "Semua Lagu Cinta Terdengar Sama",
        mp3: "music/hindia/sama.mp3",
        lyric: "lyrics/hindia/sama.js",
        artistPhoto: "/images/hindia/hindia.jpg"
      },
      {
        artist: "Hindia",
        title: "Rumah ke rumah",
        mp3: "music/hindia/rumah.mp3",
        lyric: "lyrics/hindia/rumah.js",
        artistPhoto: "/images/hindia/hindia.jpg"
      },
      {
        artist: "Hindia",
        title: "Evaluasi",
        mp3: "music/hindia/evaluasi.mp3",
        lyric: "lyrics/hindia/evaluasi.js",
        artistPhoto: "/images/hindia/hindia.jpg"
      },
      {
        artist: "Hindia",
        title: "Cincin",
        mp3: "music/hindia/cincin.mp3",
        lyric: "lyrics/hindia/cincin.js",
        artistPhoto: "/images/hindia/hindia.jpg"
      },
      {
        artist: "Hindia",
        title: "Kita Kesana",
        mp3: "music/hindia/kitakesana.mp3",
        lyric: "lyrics/hindia/kitakesana.js",
        artistPhoto: "/images/hindia/hindia.jpg"
      },
      {
        artist: "Hindia",
        title: "Rasakan Nikmatnya Hidup",
        mp3: "music/hindia/nikmatnya.mp3",
        lyric: "lyrics/hindia/nikmatnya.js",
        artistPhoto: "/images/hindia/hindia.jpg"
      },
      {
        artist: "Feast",
        title: "Feast",
        mp3: "music/nina/feast.mp3",
        lyric: "lyrics/nina/feast.js",
        artistPhoto: "/images/nina/nina.jpg"
      },
      {
        artist: "Feast",
        title: "Tarot",
        mp3: "music/nina/tarot.mp3",
        lyric: "lyrics/nina/tarot.js",
        artistPhoto: "/images/nina/nina.jpg"
      },
      {
        artist: "Feast",
        title: "o,Tuan",
        mp3: "music/nina/otuan.mp3",
        lyric: "lyrics/nina/otuan.js",
        artistPhoto: "/images/nina/nina.jpg"
      }
    ];

    // DOM Elements
    const artistList = document.getElementById('artistList');
    const playlistContainer = document.getElementById('playlist');
    const audioPlayer = document.getElementById('audioPlayer');
    const lyricsContainer = document.getElementById('lyrics');
    const backButton = document.getElementById('backButton');
    const nowPlaying = document.getElementById('nowPlaying');
    const musicControls = document.getElementById('musicControls');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playPauseIcon = document.getElementById('playPauseIcon');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const volumeSlider = document.getElementById('volumeSlider');
    const mainContent = document.getElementById('mainContent');
    const startPrompt = document.getElementById('startPrompt');

    // State
    let currentLyrics = [];
    let currentLineIndex = -1;
    let currentPlaylist = [];
    let currentSongIndex = -1;
    let isPlaying = false;
    let preloadedLyrics = {};
    let isSwitchingSong = false;

    // Cek apakah file audio valid
    async function checkAudioFile(url) {
      try {
        const response = await fetch(url, { method: 'HEAD', cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`File ${url} tidak ditemukan atau tidak dapat diakses`);
        }
        const contentType = response.headers.get('content-type');
        return audioPlayer.canPlayType(contentType) !== '';
      } catch (error) {
        console.error(`Pengecekan audio gagal untuk ${url}:`, error);
        return false;
      }
    }

    // Retry mechanism untuk play audio
    async function tryPlayAudio(audio, url, maxRetries = 3, retryDelay = 500) {
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          audio.src = url;
          audio.load();
          await audio.play();
          return true;
        } catch (error) {
          console.warn(`Percobaan ${attempt} gagal memutar ${url}:`, error);
          if (attempt === maxRetries) {
            return false;
          }
          await new Promise(resolve => setTimeout(resolve, retryDelay));
        }
      }
      return false;
    }

    // Preload semua lyrics unik saat page load
    function preloadAllLyrics() {
      const uniqueLyricPaths = [...new Set(playlist.map(song => song.lyric).filter(path => path))];
      uniqueLyricPaths.forEach(path => {
        const script = document.createElement('script');
        script.src = path;
        script.onload = () => {
          if (window.lyrics && Array.isArray(window.lyrics)) {
            preloadedLyrics[path] = window.lyrics;
            window.lyrics = null; // Clear global untuk hindari conflict
          }
        };
        script.onerror = () => {
          console.error(`Gagal preload lirik: ${path}`);
        };
        document.body.appendChild(script);
      });
    }

    // Format Waktu
    function formatTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // Partikel Animasi
    function initParticles() {
      const canvas = document.getElementById('particleCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const particleCount = 20;

      for (let i = 0; i < particleCount; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          radius: Math.random() * 1 + 0.5,
          speed: Math.random() * 0.2 + 0.1
        });
      }

      function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(229, 184, 0, 0.1)';
          ctx.fill();
          p.y -= p.speed;
          if (p.y < 0) p.y = canvas.height;
        });
        requestAnimationFrame(animateParticles);
      }

      animateParticles();
      window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });
    }

    // Load Daftar Artis
    function getArtists() {
      const artistsData = {};
      playlist.forEach(song => {
        let artistKey = song.artist;
        // Jika lagu berada di folder "random", gunakan "Random" sebagai kunci artis utama
        if (song.mp3.includes('music/random/')) {
          artistKey = 'Random';
        }
        
        if (!artistsData[artistKey]) {
          artistsData[artistKey] = {
            name: artistKey,
            songCount: 0,
            photo: song.artistPhoto // Gunakan foto artis dari lagu
          };
        }
        artistsData[artistKey].songCount++;
      });
      return Object.values(artistsData).filter(artist => artist.name);
    }

    function loadArtists() {
      if (!artistList) return;
      artistList.innerHTML = '';
      const artists = getArtists();

      artistList.style.gridTemplateColumns = 'repeat(auto-fit, minmax(200px, 1fr))';
      artistList.style.gridTemplateRows = 'auto';

      artists.forEach((artistData, index) => {
        const artistElement = document.createElement('div');
        artistElement.classList.add('artist-card', 'fade-in');
        artistElement.style.animationDelay = `${index * 0.08}s`;
        artistElement.innerHTML = `
          ${artistData.photo ? `
            <div class="mb-2 flex justify-center">
              <img src="${artistData.photo}" alt="${artistData.name}" loading="lazy"
                   class="w-24 h-24 rounded-full object-cover border border-yellow-200/40">
            </div>
          ` : `
            <div class="mb-2 flex justify-center">
              <div class="no-image w-24 h-24 rounded-full bg-yellow-200/10 flex items-center justify-center">
                <i class="fas fa-user-music text-xl text-yellow-200"></i>
              </div>
            </div>
          `}
          <h3 class="text-base font-medium text-white text-center">${artistData.name}</h3>
          <p class="text-gray-300 text-xs text-center">${artistData.songCount} lagu</p>
        `;
        artistElement.addEventListener('click', () => showArtistSongs(artistData.name));
        artistList.appendChild(artistElement);
      });

      startPrompt.classList.remove('hidden');
      lyricsContainer.classList.add('hidden');
    }

    // Tampilkan Lagu per Artis
    function showArtistSongs(artist) {
      if (!artistList || !playlistContainer || !backButton || !startPrompt || !lyricsContainer) return;
      
      artistList.classList.add('hidden');
      playlistContainer.classList.remove('hidden');
      backButton.classList.remove('hidden');
      startPrompt.classList.add('hidden');
      lyricsContainer.classList.remove('hidden');
      playlistContainer.innerHTML = '';

      // Filter lagu berdasarkan artis atau folder Random
      if (artist === 'Random') {
        currentPlaylist = playlist.filter(song => song.mp3.includes('music/random/'));
      } else {
        currentPlaylist = playlist.filter(song => song.artist === artist);
      }
      currentSongIndex = -1;

      // Header untuk artis atau folder Random
      const artistHeader = document.createElement('div');
      artistHeader.classList.add('text-center', 'mb-4', 'fade-in');
      const artistPhoto = currentPlaylist[0]?.artistPhoto;
      artistHeader.innerHTML = `
        <div class="flex flex-col items-center space-y-2">
          ${artistPhoto ? `
            <img src="${artistPhoto}" alt="${artist}" loading="lazy"
                 class="w-28 h-28 rounded-full object-cover border border-yellow-200/30">
          ` : `
            <div class="w-28 h-28 rounded-full bg-yellow-200/10 flex items-center justify-center">
              <i class="fas fa-user-music text-xl text-yellow-200"></i>
            </div>
          `}
          <div>
            <h2 class="text-lg font-medium text-white font-['Playfair_Display']">${artist}</h2>
            <p class="text-gray-300 text-xs">${currentPlaylist.length} lagu</p>
          </div>
        </div>
      `;
      playlistContainer.appendChild(artistHeader);

      // Jika artis adalah Random, kelompokkan lagu berdasarkan artis asli
      if (artist === 'Random') {
        const songsByArtist = {};
        currentPlaylist.forEach(song => {
          if (!songsByArtist[song.artist]) {
            songsByArtist[song.artist] = [];
          }
          songsByArtist[song.artist].push(song);
        });

        Object.keys(songsByArtist).forEach((artistName, artistIndex) => {
          const artistSection = document.createElement('div');
          artistSection.classList.add('mb-6');
          
          // Subheader untuk setiap artis di dalam Random
          const artistSubHeader = document.createElement('div');
          artistSubHeader.classList.add('text-left', 'mb-2');
          artistSubHeader.innerHTML = `
            <h3 class="text-base font-medium text-white">${artistName}</h3>
            <p class="text-gray-300 text-xs">${songsByArtist[artistName].length} lagu</p>
          `;
          artistSection.appendChild(artistSubHeader);

          // Tambahkan lagu-lagu untuk artis ini
          songsByArtist[artistName].forEach((song, songIndex) => {
            const globalIndex = currentPlaylist.findIndex(s => s === song);
            const songElement = document.createElement('div');
            songElement.classList.add('card', 'p-2', 'fade-in', 'flex', 'items-center', 'space-x-2', 'cursor-pointer');
            songElement.style.animationDelay = `${(artistIndex * 0.1 + songIndex * 0.04)}s`;
            songElement.dataset.songIndex = globalIndex;
            songElement.innerHTML = `
              <div class="text-yellow-200 text-base">
                <i class="fas fa-play-circle"></i>
              </div>
              <div class="flex-1">
                <h4 class="text-xs font-medium text-white">${song.title}</h4>
                <p class="text-gray-300 text-xs">${song.artist}</p>
              </div>
              <div class="text-gray-400 text-xs">
                ${globalIndex + 1}/${currentPlaylist.length}
              </div>
            `;
            songElement.addEventListener('click', () => playSong(song, globalIndex));
            artistSection.appendChild(songElement);
          });

          playlistContainer.appendChild(artistSection);
        });
      } else {
        // Tampilan lagu normal untuk artis lain
        currentPlaylist.forEach((song, index) => {
          const songElement = document.createElement('div');
          songElement.classList.add('card', 'p-2', 'fade-in', 'flex', 'items-center', 'space-x-2', 'cursor-pointer');
          songElement.style.animationDelay = `${index * 0.04}s`;
          songElement.dataset.songIndex = index;
          songElement.innerHTML = `
            <div class="text-yellow-200 text-base">
              <i class="fas fa-play-circle"></i>
            </div>
            <div class="flex-1">
              <h4 class="text-xs font-medium text-white">${song.title}</h4>
              <p class="text-gray-300 text-xs">${song.artist}</p>
            </div>
            <div class="text-gray-400 text-xs">
              ${index + 1}/${currentPlaylist.length}
            </div>
          `;
          songElement.addEventListener('click', () => playSong(song, index));
          playlistContainer.appendChild(songElement);
        });
      }
    }

    // Mainkan Lagu dengan error handling
    async function playSong(song, index) {
      if (isSwitchingSong) return;
      isSwitchingSong = true;

      // Cleanup audio
      audioPlayer.pause();
      audioPlayer.src = '';
      audioPlayer.currentTime = 0;

      try {
        // Cek apakah file audio valid
        const isValidAudio = await checkAudioFile(song.mp3);
        if (!isValidAudio) {
          nowPlaying.innerHTML = `
            <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
            File audio tidak valid: ${song.title}
          `;
          isSwitchingSong = false;
          return;
        }

        currentSongIndex = index;

        document.querySelectorAll('#playlist > div.card').forEach(el => {
          el.classList.remove('bg-yellow-200/10');
        });

        const currentSongElement = document.querySelector(`[data-song-index="${currentSongIndex}"]`);
        if (currentSongElement) {
          currentSongElement.classList.add('bg-yellow-200/10');
        }

        // Coba putar audio dengan retry
        const success = await tryPlayAudio(audioPlayer, song.mp3);
        if (success) {
          isPlaying = true;
          updatePlayPauseButton();
          musicControls.classList.remove('hidden');

          // Update nowPlaying hanya dengan info lagu
          nowPlaying.innerHTML = `
            <i class="fas fa-music mr-2"></i>
            ${song.artist} - ${song.title}
            <span class="text-gray-300 text-xs">(${currentSongIndex + 1}/${currentPlaylist.length})</span>
          `;

          loadLyrics(song.lyric);
        } else {
          nowPlaying.innerHTML = `
            <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
            Tidak dapat memutar: ${song.title}
          `;
        }
      } catch (error) {
        console.error('Error saat memutar lagu:', error);
        nowPlaying.innerHTML = `
          <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
          Tidak dapat memutar: ${song.title}
        `;
      } finally {
        isSwitchingSong = false;
      }
    }

    // Toggle Play/Pause
    async function togglePlayPause() {
      try {
        if (isPlaying) {
          audioPlayer.pause();
          isPlaying = false;
        } else {
          await audioPlayer.play();
          isPlaying = true;
        }
        updatePlayPauseButton();
      } catch (error) {
        console.error('Gagal toggle play/pause:', error);
        nowPlaying.innerHTML = `
          <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
          Tidak dapat memutar lagu
        `;
      }
    }

    function updatePlayPauseButton() {
      if (playPauseIcon) {
        playPauseIcon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
      }
    }

    // Load Lirik
    function loadLyrics(lyricPath) {
      if (!lyricsContainer) return;
      lyricsContainer.innerHTML = `
        <div class="text-center py-4">
          <i class="fas fa-spinner loading text-base text-yellow-200 mb-2"></i>
          <p class="text-gray-300 text-xs">Memuat lirik...</p>
        </div>
      `;

      if (!lyricPath) {
        lyricsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-music text-base text-gray-400 mb-2"></i>
            <p class="text-gray-300 text-xs">Tidak ada lirik</p>
          </div>
        `;
        return;
      }

      // Cek preload dulu
      if (preloadedLyrics[lyricPath]) {
        currentLyrics = preloadedLyrics[lyricPath].filter(line => 
          line && typeof line === 'object' && 
          typeof line.time === 'number' && 
          typeof line.text === 'string'
        );

        if (currentLyrics.length > 0) {
          displayLyrics();
          startAutoScroll();
        } else {
          showLyricsError('Format lirik tidak valid');
        }
        return;
      }

      // Fallback: Load manual
      const oldScript = document.getElementById('lyricScript');
      if (oldScript) oldScript.remove();

      const script = document.createElement('script');
      script.id = 'lyricScript';
      script.src = lyricPath;
      script.onload = () => {
        if (window.lyrics && Array.isArray(window.lyrics)) {
          currentLyrics = window.lyrics.filter(line => 
            line && typeof line === 'object' && 
            typeof line.time === 'number' && 
            typeof line.text === 'string'
          );

          preloadedLyrics[lyricPath] = currentLyrics;

          if (currentLyrics.length > 0) {
            displayLyrics();
            startAutoScroll();
          } else {
            showLyricsError('Format lirik tidak valid');
          }
        } else {
          showLyricsError('Lirik tidak valid');
        }
      };
      script.onerror = () => {
        console.error('Gagal memuat lirik:', lyricPath);
        showLyricsError('Gagal memuat lirik');
      };
      document.body.appendChild(script);
    }

    // Helper untuk error lirik
    function showLyricsError(message) {
      if (!lyricsContainer) return;
      lyricsContainer.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle text-base text-orange-400 mb-2"></i>
          <p class="text-gray-300 text-xs">${message}</p>
        </div>
      `;
    }

    // Tampilkan Lirik
    function displayLyrics() {
      if (!lyricsContainer) return;
      lyricsContainer.innerHTML = '';
      if (!currentLyrics || !Array.isArray(currentLyrics)) {
        lyricsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-music text-base text-gray-400 mb-2"></i>
            <p class="text-gray-300 text-xs">Tidak ada lirik</p>
          </div>
        `;
        return;
      }

      currentLyrics.forEach((line, index) => {
        const lineElement = document.createElement('div');
        lineElement.classList.add('lyric-line');
        lineElement.textContent = line.text;
        lineElement.dataset.index = index;
        lineElement.dataset.time = line.time;
        lyricsContainer.appendChild(lineElement);
      });

      currentLineIndex = -1;
      updateLyricDisplay();
    }

    // Auto Scroll Lirik
    function startAutoScroll() {
      currentLineIndex = -1;
      updateLyricDisplay();

      audioPlayer.removeEventListener('timeupdate', handleTimeUpdate);
      audioPlayer.removeEventListener('ended', handleEnded);
      audioPlayer.removeEventListener('pause', handlePause);
      audioPlayer.removeEventListener('play', handlePlay);
      audioPlayer.removeEventListener('loadedmetadata', updateDuration);

      audioPlayer.addEventListener('timeupdate', handleTimeUpdate);
      audioPlayer.addEventListener('ended', handleEnded);
      audioPlayer.addEventListener('pause', handlePause);
      audioPlayer.addEventListener('play', handlePlay);
      audioPlayer.addEventListener('loadedmetadata', updateDuration);
    }

    function handleTimeUpdate() {
      try {
        const currentTime = audioPlayer.currentTime;
        let newLineIndex = -1;

        for (let i = currentLyrics.length - 1; i >= 0; i--) {
          if (currentTime >= currentLyrics[i].time) {
            newLineIndex = i;
            break;
          }
        }

        if (newLineIndex !== currentLineIndex) {
          currentLineIndex = newLineIndex;
          updateLyricDisplay();
          if (newLineIndex >= 0) {
            scrollToCurrentLine();
          }
        }

        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressBar.style.width = `${progress}%`;
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
      } catch (error) {
        console.error('Error pada timeupdate:', error);
      }
    }

    function updateDuration() {
      try {
        durationEl.textContent = formatTime(audioPlayer.duration);
      } catch (error) {
        console.error('Error saat update durasi:', error);
      }
    }

    function handleEnded() {
      try {
        isPlaying = false;
        updatePlayPauseButton();
        currentLineIndex = -1;
        updateLyricDisplay();
        lyricsContainer.scrollTop = 0;
        playNextSong();
      } catch (error) {
        console.error('Error saat lagu selesai:', error);
      }
    }

    function handlePause() {
      try {
        isPlaying = false;
        updatePlayPauseButton();
      } catch (error) {
        console.error('Error saat pause:', error);
      }
    }

    function handlePlay() {
      try {
        isPlaying = true;
        updatePlayPauseButton();
        // Pastikan nowPlaying menunjukkan info lagu saat play
        if (currentPlaylist[currentSongIndex]) {
          nowPlaying.innerHTML = `
            <i class="fas fa-music mr-2"></i>
            ${currentPlaylist[currentSongIndex].artist} - ${currentPlaylist[currentSongIndex].title}
            <span class="text-gray-300 text-xs">(${currentSongIndex + 1}/${currentPlaylist.length})</span>
          `;
        }
      } catch (error) {
        console.error('Error saat play:', error);
      }
    }

    // Navigasi Lagu
    async function playNextSongManual() {
      if (isSwitchingSong) return;
      if (currentPlaylist.length > 0 && currentSongIndex < currentPlaylist.length - 1) {
        const nextIndex = currentSongIndex + 1;
        const nextSong = currentPlaylist[nextIndex];
        await playSong(nextSong, nextIndex);
      } else if (currentPlaylist.length > 0) {
        const firstSong = currentPlaylist[0];
        await playSong(firstSong, 0);
      }
    }

    async function playPreviousSong() {
      if (isSwitchingSong) return;
      if (currentPlaylist.length > 0 && currentSongIndex > 0) {
        const prevIndex = currentSongIndex - 1;
        const prevSong = currentPlaylist[prevIndex];
        await playSong(prevSong, prevIndex);
      } else if (currentPlaylist.length > 0) {
        const lastIndex = currentPlaylist.length - 1;
        const lastSong = currentPlaylist[lastIndex];
        await playSong(lastSong, lastIndex);
      }
    }

    async function playNextSong() {
      if (currentPlaylist.length > 0 && currentSongIndex < currentPlaylist.length - 1) {
        const nextIndex = currentSongIndex + 1;
        const nextSong = currentPlaylist[nextIndex];
        await playSong(nextSong, nextIndex);
      } else {
        nowPlaying.innerHTML = `
          <i class="fas fa-check-circle mr-2 text-green-400"></i>
          Playlist selesai
        `;
        musicControls.classList.add('hidden');
        currentSongIndex = -1;
        document.querySelectorAll('#playlist > div.card').forEach(el => {
          el.classList.remove('bg-yellow-200/10');
        });
      }
    }

    // Update Tampilan Lirik
    function updateLyricDisplay() {
      try {
        const lyricLines = document.querySelectorAll('.lyric-line');
        lyricLines.forEach((line, index) => {
          line.classList.remove('current', 'passed', 'upcoming');
          if (currentLineIndex === -1) {
            line.classList.add('upcoming');
          } else if (index < currentLineIndex) {
            line.classList.add('passed');
          } else if (index === currentLineIndex) {
            line.classList.add('current');
          } else {
            line.classList.add('upcoming');
          }
        });
      } catch (error) {
        console.error('Error saat update lirik:', error);
      }
    }

    // Scroll ke Baris Lirik Aktif
    function scrollToCurrentLine() {
      try {
        const currentLine = document.querySelector(`[data-index="${currentLineIndex}"]`);
        if (currentLine) {
          currentLine.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        }
      } catch (error) {
        console.error('Error saat scroll lirik:', error);
      }
    }

    // Debounce untuk mousemove
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Parallax Efek
    const handleMouseMove = debounce((e) => {
      try {
        const x = (e.clientX / window.innerWidth) - 0.5;
        const y = (e.clientY / window.innerHeight) - 0.5;
        mainContent.style.transform = `rotateX(${y * 2}deg) rotateY(${x * -2}deg) translateZ(0)`;
        const artistCards = document.querySelectorAll('.artist-card');
        artistCards.forEach(card => {
          card.style.transform = `translate(${x * 8}px, ${y * 8}px) translateZ(8px)`;
        });
      } catch (error) {
        console.error('Error pada parallax effect:', error);
      }
    }, 15);

    // Event Listeners
    if (backButton) {
      backButton.addEventListener('click', () => {
        try {
          artistList.classList.remove('hidden');
          playlistContainer.classList.add('hidden');
          backButton.classList.add('hidden');
          startPrompt.classList.remove('hidden');
          lyricsContainer.classList.add('hidden');
          musicControls.classList.add('hidden');
          audioPlayer.pause();
          audioPlayer.src = '';
          isPlaying = false;
          updatePlayPauseButton();
          nowPlaying.textContent = '';
          lyricsContainer.innerHTML = '';
          currentLyrics = [];
          currentLineIndex = -1;
          currentPlaylist = [];
          currentSongIndex = -1;
          playlistContainer.innerHTML = '';

          audioPlayer.removeEventListener('timeupdate', handleTimeUpdate);
          audioPlayer.removeEventListener('ended', handleEnded);
          audioPlayer.removeEventListener('pause', handlePause);
          audioPlayer.removeEventListener('play', handlePlay);
          audioPlayer.removeEventListener('loadedmetadata', updateDuration);

          loadArtists();
        } catch (error) {
          console.error('Error saat kembali ke daftar artis:', error);
        }
      });
    }

    if (progressContainer) {
      progressContainer.addEventListener('click', (e) => {
        try {
          const rect = progressContainer.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const width = rect.width;
          const percentage = clickX / width;
          audioPlayer.currentTime = percentage * audioPlayer.duration;
        } catch (error) {
          console.error('Error saat mengatur progress:', error);
        }
      });
    }

    if (volumeSlider) {
      volumeSlider.addEventListener('input', () => {
        try {
          audioPlayer.volume = volumeSlider.value;
        } catch (error) {
          console.error('Error saat mengatur volume:', error);
        }
      });
    }

    window.addEventListener('mousemove', handleMouseMove);

    // Inisialisasi
    document.addEventListener('DOMContentLoaded', () => {
      try {
        initParticles();
        preloadAllLyrics();
        loadArtists();
      } catch (error) {
        console.error('Error saat inisialisasi:', error);
      }
    });
  </script>
</body>
</html>