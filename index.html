<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Playlist musik favorit dengan pengalaman premium dan timer tidur">
  <title>Playlist Musik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <canvas id="particleCanvas"></canvas>
  <div id="mainContent" class="container max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6 relative">
    <div class="glass-effect rounded-xl p-6 sm:p-8 relative z-10">
      <div id="startPrompt" class="start-prompt text-lg sm:text-xl mb-6 fade-in">
        Jelajahi Koleksi Musik
      </div>
      <button id="backButton" class="hidden mb-6 px-4 py-2 bg-accent text-dark rounded-lg hover:bg-accent-hover transition-all duration-300 font-medium text-sm">
        <i class="fas fa-arrow-left mr-2"></i>
        Kembali
      </button>

      <div id="albumList" class="grid-responsive"></div>

      <div id="playlist" class="hidden">
        <div id="playlistHeader" class="mb-4"></div>
        <div id="timerSection" class="timer-section mb-6">
          <div class="glass-effect rounded-lg p-3 flex items-center gap-2 flex-wrap">
            <i class="fas fa-clock text-accent text-base"></i>
            <span class="text-sm font-medium text-muted mr-2">Timer Tidur:</span>
            <div class="timer-presets">
              <button class="timer-preset" data-minutes="5">5m</button>
              <button class="timer-preset" data-minutes="10">10m</button>
              <button class="timer-preset" data-minutes="15">15m</button>
              <button class="timer-preset" data-minutes="30">30m</button>
              <button class="timer-preset" data-minutes="45">45m</button>
              <button class="timer-preset" data-minutes="60">60m</button>
              <button id="customTimerBtn" class="timer-preset">Custom</button>
            </div>
            <div id="customTimerInput" class="timer-custom hidden">
              <input type="number" id="customMinutes" min="1" max="180" placeholder="Menit (1-180)" class="timer-input">
              <div class="timer-actions">
                <button id="setCustomTimer" class="btn btn-primary">Set</button>
                <button id="clearTimer" class="btn btn-ghost">Clear</button>
              </div>
            </div>
            <span id="timerCountdown" class="timer-countdown hidden">Sisa: 00:00</span>
          </div>
        </div>
        <div id="songList" class="song-list"></div>
      </div>

      <audio id="audioPlayer" preload="auto" class="hidden"></audio>

      <div id="musicControls" class="hidden mt-6">
        <div class="glass-effect rounded-xl p-6">
          <div id="nowPlaying" class="text-base font-medium now-playing-text mb-4"></div>
          
          <div class="progress-container mb-4" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          
          <div class="flex justify-between text-sm text-gray-300 mb-4">
            <span id="currentTime">0:00</span>
            <span id="duration">0:00</span>
          </div>

          <div class="flex items-center justify-center space-x-4">
            <button onclick="playPreviousSong()" class="control-btn w-10 h-10 text-white flex items-center justify-center" data-tooltip="Lagu Sebelumnya">
              <i class="fas fa-step-backward text-base"></i>
            </button>
            
            <button id="playPauseBtn" onclick="togglePlayPause()" class="control-btn w-12 h-12 text-white flex items-center justify-center text-lg" data-tooltip="Play/Pause">
              <i id="playPauseIcon" class="fas fa-play"></i>
            </button>
            
            <button onclick="playNextSongManual()" class="control-btn w-10 h-10 text-white flex items-center justify-center" data-tooltip="Lagu Selanjutnya">
              <i class="fas fa-step-forward text-base"></i>
            </button>

            <div class="volume-container">
              <i class="fas fa-volume-up text-gray-300"></i>
              <input type="range" min="0" max="1" step="0.01" value="1" class="volume-slider" id="volumeSlider">
            </div>
          </div>
        </div>
      </div>

      <div id="lyrics" class="hidden mt-6 p-6 glass-effect rounded-xl text-white text-base max-h-80 overflow-y-auto"></div>

      <footer class="mt-8 glass-effect rounded-xl p-4 flex justify-center space-x-4">
        <a href="https://instagram.com/yudis_299" target="_blank" class="contact-btn">
          <i class="fab fa-instagram text-base"></i>
          <span class="contact-label">Instagram</span>
        </a>
        <a href="https://wa.me/6285124039070" target="_blank" class="contact-btn">
          <i class="fab fa-whatsapp text-base"></i>
          <span class="contact-label">WhatsApp</span>
        </a>
      </footer>
    </div>
  </div>

  <script>
    // Playlist dari localStorage
    let playlist = JSON.parse(localStorage.getItem('playlist')) || [
      {
        artist: "Kendis",
        title: "ours to keep",
        mp3: "music/random/keep.mp3",
        lyric: "lyrics/random/keep.js",
        artistPhoto: "/images/random/randomm.jpg",
        folder: "Random Barat ðŸª©"
      },
      {
        artist: "Matty Healy",
        title: "About You",
        mp3: "music/random/aboutyou.mp3",
        lyric: "lyrics/random/aboutyou.js",
        artistPhoto: "/images/random/randomm.jpg",
        folder: "Random Barat ðŸª©"
      },
      {
        artist: "Dougy Mandagi",
        title: "Sweet disposition",
        mp3: "music/random/disposition.mp3",
        lyric: "lyrics/random/disposition.js",
        artistPhoto: "/images/random/randomm.jpg",
        folder: "Random Barat ðŸª©"
      },
      {
        artist: "One direction",
        title: "where we are",
        mp3: "music/random/weare.mp3",
        lyric: "lyrics/random/weare.js",
        artistPhoto: "/images/random/randomm.jpg",
        folder: "Random Barat ðŸª©"
      },
      {
        artist: "Nadhif Basalamah",
        title: "Bergema Sampai Selamanya",
        mp3: "music/random/bergema.mp3",
        lyric: "lyrics/random/bergema.js",
        artistPhoto: "/images/random/random.jpg",
        folder: "Random Lokal ðŸš€"
      },
      {
        artist: "Nadhif Basalamah",
        title: "Penjaga Hati",
        mp3: "music/random/penjagahati.mp3",
        lyric: "lyrics/random/penjagahati.js",
        artistPhoto: "/images/random/random.jpg",
        folder: "Random Lokal ðŸš€"
      },
      {
        artist: "Aris Lesmana",
        title: "Mangu",
        mp3: "music/random/mangu.mp3",
        lyric: "lyrics/random/mangu.js",
        artistPhoto: "/images/random/random.jpg",
        folder: "Random Lokal ðŸš€"
      },
      {
        artist: "Hindia",
        title: "Everything U Are",
        mp3: "music/hindia/everything.mp3",
        lyric: "lyrics/hindia/everything.js",
        artistPhoto: "/images/hindia/hindia.jpg",
        folder: "Hindia"
      },
      {
        artist: "Hindia",
        title: "Ramai Sepi Bersama",
        mp3: "music/hindia/bersama.mp3",
        lyric: "lyrics/hindia/bersama.js",
        artistPhoto: "/images/hindia/hindia.jpg",
        folder: "Hindia"
      },
      {
        artist: "Hindia",
        title: "Semua Lagu Cinta Terdengar Sama",
        mp3: "music/hindia/sama.mp3",
        lyric: "lyrics/hindia/sama.js",
        artistPhoto: "/images/hindia/hindia.jpg",
        folder: "Hindia"
      },
      {
        artist: "Hindia",
        title: "Rumah ke rumah",
        mp3: "music/hindia/rumah.mp3",
        lyric: "lyrics/hindia/rumah.js",
        artistPhoto: "/images/hindia/hindia.jpg",
        folder: "Hindia"
      },
      {
        artist: "Hindia",
        title: "Evaluasi",
        mp3: "music/hindia/evaluasi.mp3",
        lyric: "lyrics/hindia/evaluasi.js",
        artistPhoto: "/images/hindia/hindia.jpg",
        folder: "Hindia"
      },
      {
        artist: "Hindia",
        title: "Cincin",
        mp3: "music/hindia/cincin.mp3",
        lyric: "lyrics/hindia/cincin.js",
        artistPhoto: "/images/hindia/hindia.jpg",
        folder: "Hindia"
      },
      {
        artist: "Hindia",
        title: "Kita Kesana",
        mp3: "music/hindia/kitakesana.mp3",
        lyric: "lyrics/hindia/kitakesana.js",
        artistPhoto: "/images/hindia/hindia.jpg",
        folder: "Hindia"
      },
      {
        artist: "Hindia",
        title: "Rasakan Nikmatnya Hidup",
        mp3: "music/hindia/nikmatnya.mp3",
        lyric: "lyrics/hindia/nikmatnya.js",
        artistPhoto: "/images/hindia/hindia.jpg",
        folder: "Hindia"
      },
      {
        artist: "Feast",
        title: "Feast",
        mp3: "music/nina/feast.mp3",
        lyric: "lyrics/nina/feast.js",
        artistPhoto: "/images/nina/nina.jpg",
        folder: "Feast"
      },
      {
        artist: "Feast",
        title: "Tarot",
        mp3: "music/nina/tarot.mp3",
        lyric: "lyrics/nina/tarot.js",
        artistPhoto: "/images/nina/nina.jpg",
        folder: "Feast"
      },
      {
        artist: "Feast",
        title: "o,Tuan",
        mp3: "music/nina/otuan.mp3",
        lyric: "lyrics/nina/otuan.js",
        artistPhoto: "/images/nina/nina.jpg",
        folder: "Feast"
      }
    ];

    // DOM Elements
    const albumList = document.getElementById('albumList');
    const playlistContainer = document.getElementById('playlist');
    const playlistHeader = document.getElementById('playlistHeader');
    const songList = document.getElementById('songList');
    const audioPlayer = document.getElementById('audioPlayer');
    const lyricsContainer = document.getElementById('lyrics');
    const backButton = document.getElementById('backButton');
    const nowPlaying = document.getElementById('nowPlaying');
    const musicControls = document.getElementById('musicControls');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playPauseIcon = document.getElementById('playPauseIcon');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const volumeSlider = document.getElementById('volumeSlider');
    const mainContent = document.getElementById('mainContent');
    const startPrompt = document.getElementById('startPrompt');
    const timerCountdown = document.getElementById('timerCountdown');
    const customTimerInput = document.getElementById('customTimerInput');
    const customMinutesInput = document.getElementById('customMinutes');
    const setCustomTimer = document.getElementById('setCustomTimer');
    const customTimerBtn = document.getElementById('customTimerBtn');
    const clearTimer = document.getElementById('clearTimer');
    const timerPresets = document.querySelectorAll('.timer-preset');

    // State
    let currentLyrics = [];
    let currentLineIndex = -1;
    let currentPlaylist = [];
    let currentSongIndex = -1;
    let isPlaying = false;
    let preloadedLyrics = {};
    let isSwitchingSong = false;
    let timerId = null;
    let timerEndTime = null;
    let hasScrolled = false;

    function getAlbumFromPath(song) {
      return song.folder || 'unknown';
    }

    async function checkAudioFile(url) {
      try {
        const response = await fetch(url, { method: 'HEAD', cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`File ${url} tidak ditemukan atau tidak dapat diakses`);
        }
        const contentType = response.headers.get('content-type');
        return audioPlayer.canPlayType(contentType) !== '';
      } catch (error) {
        console.error(`Pengecekan audio gagal untuk ${url}:`, error);
        return false;
      }
    }

    async function tryPlayAudio(audio, url, maxRetries = 3, retryDelay = 500) {
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          audio.src = url;
          audio.load();
          await audio.play();
          return true;
        } catch (error) {
          console.warn(`Percobaan ${attempt} gagal memutar ${url}:`, error);
          if (attempt === maxRetries) {
            return false;
          }
          await new Promise(resolve => setTimeout(resolve, retryDelay));
        }
      }
      return false;
    }

    function preloadAllLyrics() {
      const uniqueLyricPaths = [...new Set(playlist.map(song => song.lyric).filter(path => path))];
      uniqueLyricPaths.forEach(path => {
        const script = document.createElement('script');
        script.src = path;
        script.onload = () => {
          if (window.lyrics && Array.isArray(window.lyrics)) {
            preloadedLyrics[path] = window.lyrics;
            window.lyrics = null;
          }
        };
        script.onerror = () => {
          console.error(`Gagal preload lirik: ${path}`);
        };
        document.body.appendChild(script);
      });
    }

    function formatTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function updateTimerCountdown() {
      if (!timerEndTime || !timerCountdown) return;
      const now = Date.now();
      const remainingMs = timerEndTime - now;
      if (remainingMs <= 0) {
        timerCountdown.classList.add('hidden');
        clearTimeout(timerId);
        clearInterval(timerId);
        timerId = null;
        timerEndTime = null;
        resetTimerPresets();
        customTimerInput.classList.add('hidden');
        return;
      }
      const remainingSeconds = Math.floor(remainingMs / 1000);
      timerCountdown.textContent = `Sisa: ${formatTime(remainingSeconds)}`;
      timerCountdown.classList.remove('hidden');
    }

    function setSleepTimer(minutes) {
      if (timerId) {
        clearTimeout(timerId);
        clearInterval(timerId);
        timerId = null;
      }
      timerCountdown.classList.add('hidden');
      timerEndTime = null;

      if (minutes > 0) {
        const milliseconds = minutes * 60 * 1000;
        timerEndTime = Date.now() + milliseconds;
        timerId = setTimeout(() => {
          audioPlayer.pause();
          isPlaying = false;
          updatePlayPauseButton();
          nowPlaying.innerHTML = `
            <i class="fas fa-moon mr-2 text-accent"></i>
            ${currentPlaylist[currentSongIndex]?.artist || 'Artis'} - ${currentPlaylist[currentSongIndex]?.title || 'Judul'}
            <span class="text-gray-300 text-xs">(${currentSongIndex + 1}/${currentPlaylist.length})</span>
          `;
          timerCountdown.classList.add('hidden');
          clearTimeout(timerId);
          clearInterval(timerId);
          timerId = null;
          timerEndTime = null;
          resetTimerPresets();
          customTimerInput.classList.add('hidden');
        }, milliseconds);
        timerId = setInterval(updateTimerCountdown, 1000);
        updateTimerCountdown();
      }
    }

    function resetTimerPresets() {
      timerPresets.forEach(btn => btn.classList.remove('active'));
    }

    function initParticles() {
      const canvas = document.getElementById('particleCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const particleCount = 10;

      for (let i = 0; i < particleCount; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          radius: Math.random() * 1.2 + 0.3,
          speed: Math.random() * 0.1 + 0.03,
          opacity: Math.random() * 0.2 + 0.05
        });
      }

      function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`;
          ctx.fill();
          p.y -= p.speed;
          if (p.y < 0) p.y = canvas.height;
        });
        requestAnimationFrame(animateParticles);
      }

      animateParticles();
      window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });
    }

    function getAlbums() {
      const albumsData = {};
      playlist.forEach(song => {
        const folderName = getAlbumFromPath(song);
        if (!albumsData[folderName]) {
          albumsData[folderName] = {
            name: folderName,
            songCount: 0,
            photo: song.artistPhoto,
            artist: song.artist
          };
        }
        albumsData[folderName].songCount++;
      });
      return Object.values(albumsData).filter(album => album.name);
    }

    function loadAlbums() {
      if (!albumList) return;
      albumList.innerHTML = '';
      const albums = getAlbums();

      albumList.style.gridTemplateColumns = 'repeat(auto-fit, minmax(200px, 1fr))';
      albumList.style.gridTemplateRows = 'auto';

      if (albums.length === 0) {
        albumList.innerHTML = '<p class="text-center text-gray-300">Tidak ada album ditemukan</p>';
        return;
      }

      albums.forEach((albumData, index) => {
        const albumElement = document.createElement('div');
        albumElement.classList.add('album-card', 'fade-in');
        albumElement.style.animationDelay = `${index * 0.06}s`;
        albumElement.innerHTML = `
          ${albumData.photo ? `
            <div class="mb-2 flex justify-center">
              <img src="${albumData.photo}" alt="${albumData.name}" loading="lazy"
                   class="w-24 h-24 rounded-lg object-cover border border-accent">
            </div>
          ` : `
            <div class="mb-2 flex justify-center">
              <div class="no-image w-24 h-24 rounded-lg bg-dark-accent flex items-center justify-center">
                <i class="fas fa-compact-disc text-xl text-accent"></i>
              </div>
            </div>
          `}
          <h3 class="text-base font-medium text-white text-center">${albumData.name}</h3>
          <p class="text-gray-300 text-xs text-center">${albumData.songCount} lagu</p>
        `;
        albumElement.addEventListener('click', () => showAlbumSongs(albumData.name));
        albumList.appendChild(albumElement);
      });

      startPrompt.classList.remove('hidden');
      playlistContainer.classList.add('hidden');
      lyricsContainer.classList.add('hidden');
      musicControls.classList.add('hidden');
    }

    function showAlbumSongs(album) {
      if (!albumList || !playlistContainer || !backButton || !startPrompt || !lyricsContainer || !songList) return;
      
      albumList.classList.add('hidden');
      playlistContainer.classList.remove('hidden');
      backButton.classList.remove('hidden');
      startPrompt.classList.add('hidden');
      lyricsContainer.classList.remove('hidden');
      songList.innerHTML = '';

      const filteredSongs = playlist.filter(song => getAlbumFromPath(song) === album);
      currentPlaylist = filteredSongs;
      currentSongIndex = -1;

      const albumHeader = document.createElement('div');
      albumHeader.classList.add('text-center', 'mb-4', 'fade-in');
      const albumPhoto = currentPlaylist[0]?.artistPhoto;
      const albumArtist = currentPlaylist[0]?.artist;
      albumHeader.innerHTML = `
        <div class="flex flex-col items-center space-y-2">
          ${albumPhoto ? `
            <img src="${albumPhoto}" alt="${album}" loading="lazy"
                 class="w-28 h-28 rounded-lg object-cover border border-accent">
          ` : `
            <div class="w-28 h-28 rounded-lg bg-dark-accent flex items-center justify-center">
              <i class="fas fa-compact-disc text-xl text-accent"></i>
            </div>
          `}
          <div>
            <h2 class="text-lg font-medium text-white font-['Space_Mono']">${album.charAt(0).toUpperCase() + album.slice(1)}</h2>
            <p class="text-gray-300 text-xs">${albumArtist} - ${currentPlaylist.length} lagu</p>
          </div>
        </div>
      `;
      playlistHeader.innerHTML = '';
      playlistHeader.appendChild(albumHeader);

      if (currentPlaylist.length === 0) {
        songList.innerHTML = '<p class="text-center text-gray-300">Tidak ada lagu ditemukan</p>';
        return;
      }

      currentPlaylist.forEach((song, index) => {
        const songElement = document.createElement('div');
        songElement.classList.add('card', 'p-2', 'fade-in', 'flex', 'items-center', 'space-x-2', 'cursor-pointer');
        songElement.style.animationDelay = `${index * 0.03}s`;
        songElement.dataset.songIndex = index;
        songElement.innerHTML = `
          <div class="text-accent text-base">
            <i class="fas fa-play-circle"></i>
          </div>
          <div class="flex-1">
            <h4 class="text-xs font-medium text-white">${song.title}</h4>
            <p class="text-gray-300 text-xs">${song.artist}</p>
          </div>
          <div class="text-gray-400 text-xs">
            ${index + 1}/${currentPlaylist.length}
          </div>
        `;
        songElement.addEventListener('click', () => playSong(song, index));
        songList.appendChild(songElement);
      });
    }

    async function playSong(song, index) {
      if (isSwitchingSong) return;
      isSwitchingSong = true;
      hasScrolled = false;

      audioPlayer.pause();
      audioPlayer.src = '';
      audioPlayer.currentTime = 0;

      try {
        const isValidAudio = await checkAudioFile(song.mp3);
        if (!isValidAudio) {
          nowPlaying.innerHTML = `
            <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
            File audio tidak valid: ${song.title}
          `;
          isSwitchingSong = false;
          return;
        }

        currentSongIndex = index;

        document.querySelectorAll('#songList > div.card').forEach(el => {
          el.classList.remove('bg-dark-accent');
        });

        const currentSongElement = document.querySelector(`[data-songIndex="${currentSongIndex}"]`);
        if (currentSongElement) {
          currentSongElement.classList.add('bg-dark-accent');
        }

        const success = await tryPlayAudio(audioPlayer, song.mp3);
        if (success) {
          isPlaying = true;
          updatePlayPauseButton();
          musicControls.classList.remove('hidden');

          nowPlaying.innerHTML = `
            <i class="fas fa-music mr-2"></i>
            ${song.artist} - ${song.title}
            <span class="text-gray-300 text-xs">(${currentSongIndex + 1}/${currentPlaylist.length})</span>
          `;

          loadLyrics(song.lyric);

          setTimeout(() => {
            if (lyricsContainer && !hasScrolled) {
              lyricsContainer.classList.remove('hidden');
              lyricsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
              hasScrolled = true;
            }
          }, 400);
        } else {
          nowPlaying.innerHTML = `
            <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
            Tidak dapat memutar: ${song.title}
          `;
        }
      } catch (error) {
        console.error('Error saat memutar lagu:', error);
        nowPlaying.innerHTML = `
          <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
          Tidak dapat memutar: ${song.title}
        `;
      } finally {
        isSwitchingSong = false;
      }
    }

    async function togglePlayPause() {
      try {
        if (isPlaying) {
          audioPlayer.pause();
          isPlaying = false;
        } else {
          await audioPlayer.play();
          isPlaying = true;
          if (!timerEndTime) {
            resetTimerPresets();
            customTimerInput.classList.add('hidden');
            timerCountdown.classList.add('hidden');
          }
        }
        updatePlayPauseButton();
      } catch (error) {
        console.error('Gagal toggle play/pause:', error);
        nowPlaying.innerHTML = `
          <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
          Tidak dapat memutar lagu
        `;
      }
    }

    function updatePlayPauseButton() {
      if (playPauseIcon) {
        playPauseIcon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
      }
    }

    function loadLyrics(lyricPath) {
      if (!lyricsContainer) return;
      lyricsContainer.innerHTML = `
        <div class="text-center py-4">
          <i class="fas fa-spinner loading text-base text-accent mb-2"></i>
          <p class="text-gray-300 text-xs">Memuat lirik...</p>
        </div>
      `;

      if (!lyricPath) {
        lyricsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-music text-base text-gray-400 mb-2"></i>
            <p class="text-gray-300 text-xs">Tidak ada lirik</p>
          </div>
        `;
        return;
      }

      if (preloadedLyrics[lyricPath]) {
        currentLyrics = preloadedLyrics[lyricPath].filter(line => 
          line && typeof line === 'object' && 
          typeof line.time === 'number' && 
          typeof line.text === 'string'
        );

        if (currentLyrics.length > 0) {
          displayLyrics();
          startAutoScroll();
        } else {
          showLyricsError('Format lirik tidak valid');
        }
        return;
      }

      const oldScript = document.getElementById('lyricScript');
      if (oldScript) oldScript.remove();

      const script = document.createElement('script');
      script.id = 'lyricScript';
      script.src = lyricPath;
      script.onload = () => {
        if (window.lyrics && Array.isArray(window.lyrics)) {
          currentLyrics = window.lyrics.filter(line => 
            line && typeof line === 'object' && 
            typeof line.time === 'number' && 
            typeof line.text === 'string'
          );

          preloadedLyrics[lyricPath] = currentLyrics;

          if (currentLyrics.length > 0) {
            displayLyrics();
            startAutoScroll();
          } else {
            showLyricsError('Format lirik tidak valid');
          }
        } else {
          showLyricsError('Lirik tidak valid');
        }
      };
      script.onerror = () => {
        console.error('Gagal memuat lirik:', lyricPath);
        showLyricsError('Gagal memuat lirik');
      };
      document.body.appendChild(script);
    }

    function showLyricsError(message) {
      if (!lyricsContainer) return;
      lyricsContainer.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle text-base text-orange-400 mb-2"></i>
          <p class="text-gray-300 text-xs">${message}</p>
        </div>
      `;
    }

    function displayLyrics() {
      if (!lyricsContainer) return;
      lyricsContainer.innerHTML = '';
      if (!currentLyrics || !Array.isArray(currentLyrics)) {
        lyricsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-music text-base text-gray-400 mb-2"></i>
            <p class="text-gray-300 text-xs">Tidak ada lirik</p>
          </div>
        `;
        return;
      }

      currentLyrics.forEach((line, index) => {
        const lineElement = document.createElement('div');
        lineElement.classList.add('lyric-line');
        lineElement.textContent = line.text;
        lineElement.dataset.index = index;
        lineElement.dataset.time = line.time;
        lyricsContainer.appendChild(lineElement);
      });

      currentLineIndex = -1;
      updateLyricDisplay();
    }

    function startAutoScroll() {
      currentLineIndex = -1;
      updateLyricDisplay();

      audioPlayer.removeEventListener('timeupdate', handleTimeUpdate);
      audioPlayer.removeEventListener('ended', handleEnded);
      audioPlayer.removeEventListener('pause', handlePause);
      audioPlayer.removeEventListener('play', handlePlay);
      audioPlayer.removeEventListener('loadedmetadata', updateDuration);

      audioPlayer.addEventListener('timeupdate', handleTimeUpdate);
      audioPlayer.addEventListener('ended', handleEnded);
      audioPlayer.addEventListener('pause', handlePause);
      audioPlayer.addEventListener('play', handlePlay);
      audioPlayer.addEventListener('loadedmetadata', updateDuration);
    }

    function handleTimeUpdate() {
      try {
        const currentTime = audioPlayer.currentTime;
        let newLineIndex = -1;

        for (let i = currentLyrics.length - 1; i >= 0; i--) {
          if (currentTime >= currentLyrics[i].time) {
            newLineIndex = i;
            break;
          }
        }

        if (newLineIndex !== currentLineIndex) {
          currentLineIndex = newLineIndex;
          updateLyricDisplay();
          if (newLineIndex >= 0) {
            scrollToCurrentLine();
          }
        }

        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressBar.style.width = `${progress}%`;
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
      } catch (error) {
        console.error('Error pada timeupdate:', error);
      }
    }

    function updateDuration() {
      try {
        durationEl.textContent = formatTime(audioPlayer.duration);
      } catch (error) {
        console.error('Error saat update durasi:', error);
      }
    }

    function handleEnded() {
      try {
        isPlaying = false;
        updatePlayPauseButton();
        currentLineIndex = -1;
        updateLyricDisplay();
        lyricsContainer.scrollTop = 0;
        hasScrolled = false;
        playNextSong();
      } catch (error) {
        console.error('Error saat lagu selesai:', error);
      }
    }

    function handlePause() {
      try {
        isPlaying = false;
        updatePlayPauseButton();
      } catch (error) {
        console.error('Error saat pause:', error);
      }
    }

    function handlePlay() {
      try {
        isPlaying = true;
        updatePlayPauseButton();
        if (currentPlaylist[currentSongIndex]) {
          nowPlaying.innerHTML = `
            <i class="fas fa-music mr-2"></i>
            ${currentPlaylist[currentSongIndex].artist} - ${currentPlaylist[currentSongIndex].title}
            <span class="text-gray-300 text-xs">(${currentSongIndex + 1}/${currentPlaylist.length})</span>
          `;
        }
      } catch (error) {
        console.error('Error saat play:', error);
      }
    }

    async function playNextSongManual() {
      if (isSwitchingSong) return;
      let nextIndex = currentSongIndex + 1;
      if (nextIndex >= currentPlaylist.length) {
        nextIndex = 0;
      }
      const nextSong = currentPlaylist[nextIndex];
      await playSong(nextSong, nextIndex);
    }

    async function playPreviousSong() {
      if (isSwitchingSong) return;
      let prevIndex = currentSongIndex - 1;
      if (prevIndex < 0) {
        prevIndex = currentPlaylist.length - 1;
      }
      const prevSong = currentPlaylist[prevIndex];
      await playSong(prevSong, prevIndex);
    }

    async function playNextSong() {
      let nextIndex = currentSongIndex + 1;
      if (nextIndex >= currentPlaylist.length) {
        nowPlaying.innerHTML = `
          <i class="fas fa-check-circle mr-2 text-green-400"></i>
          Playlist selesai
        `;
        musicControls.classList.add('hidden');
        currentSongIndex = -1;
        document.querySelectorAll('#songList > div.card').forEach(el => {
          el.classList.remove('bg-dark-accent');
        });
        return;
      }
      const nextSong = currentPlaylist[nextIndex];
      await playSong(nextSong, nextIndex);
    }

    function updateLyricDisplay() {
      try {
        const lyricLines = document.querySelectorAll('.lyric-line');
        lyricLines.forEach((line, index) => {
          line.classList.remove('current', 'passed', 'upcoming');
          if (currentLineIndex === -1) {
            line.classList.add('upcoming');
          } else if (index < currentLineIndex) {
            line.classList.add('passed');
          } else if (index === currentLineIndex) {
            line.classList.add('current');
          } else {
            line.classList.add('upcoming');
          }
        });
      } catch (error) {
        console.error('Error saat update lirik:', error);
      }
    }

    function scrollToCurrentLine() {
      try {
        if (hasScrolled) return;
        const currentLine = document.querySelector(`.lyric-line[data-index="${currentLineIndex}"]`);
        if (currentLine && lyricsContainer) {
          const lineRect = currentLine.getBoundingClientRect();
          const containerRect = lyricsContainer.getBoundingClientRect();
          const offset = lineRect.top - containerRect.top + lyricsContainer.scrollTop - (containerRect.height / 2) + (lineRect.height / 2);
          lyricsContainer.scrollTo({
            top: offset,
            behavior: 'smooth'
          });
          hasScrolled = true;
        }
      } catch (error) {
        console.error('Error saat scroll lirik:', error);
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    const handleMouseMove = debounce((e) => {
      try {
        const x = (e.clientX / window.innerWidth) - 0.5;
        const y = (e.clientY / window.innerHeight) - 0.5;
        mainContent.style.transform = `rotateX(${y * 1.2}deg) rotateY(${x * -1.2}deg) translateZ(0)`;
        const albumCards = document.querySelectorAll('.album-card');
        albumCards.forEach(card => {
          card.style.transform = `translate(${x * 5}px, ${y * 5}px) translateZ(5px)`;
        });
      } catch (error) {
        console.error('Error pada parallax effect:', error);
      }
    }, 60);

    if (backButton) {
      backButton.addEventListener('click', () => {
        try {
          albumList.classList.remove('hidden');
          playlistContainer.classList.add('hidden');
          backButton.classList.add('hidden');
          startPrompt.classList.remove('hidden');
          lyricsContainer.classList.add('hidden');
          musicControls.classList.add('hidden');
          audioPlayer.pause();
          audioPlayer.src = '';
          isPlaying = false;
          updatePlayPauseButton();
          nowPlaying.textContent = '';
          lyricsContainer.innerHTML = '';
          currentLyrics = [];
          currentLineIndex = -1;
          currentPlaylist = [];
          currentSongIndex = -1;
          songList.innerHTML = '';
          hasScrolled = false;

          if (timerId) {
            clearTimeout(timerId);
            clearInterval(timerId);
            timerId = null;
            timerEndTime = null;
            timerCountdown.classList.add('hidden');
            resetTimerPresets();
            customTimerInput.classList.add('hidden');
          }

          audioPlayer.removeEventListener('timeupdate', handleTimeUpdate);
          audioPlayer.removeEventListener('ended', handleEnded);
          audioPlayer.removeEventListener('pause', handlePause);
          audioPlayer.removeEventListener('play', handlePlay);
          audioPlayer.removeEventListener('loadedmetadata', updateDuration);

          loadAlbums();
        } catch (error) {
          console.error('Error saat kembali ke daftar album:', error);
        }
      });
    }

    if (progressContainer) {
      progressContainer.addEventListener('click', (e) => {
        try {
          const rect = progressContainer.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const width = rect.width;
          const percentage = clickX / width;
          audioPlayer.currentTime = percentage * audioPlayer.duration;
        } catch (error) {
          console.error('Error saat mengatur progress:', error);
        }
      });
    }

    if (volumeSlider) {
      volumeSlider.addEventListener('input', () => {
        try {
          audioPlayer.volume = volumeSlider.value;
        } catch (error) {
          console.error('Error saat mengatur volume:', error);
        }
      });
    }

    // Timer event listeners
    timerPresets.forEach(button => {
      if (button.id !== 'customTimerBtn') {
        button.addEventListener('click', () => {
          resetTimerPresets();
          button.classList.add('active');
          const minutes = parseInt(button.dataset.minutes);
          setSleepTimer(minutes);
          customTimerInput.classList.add('hidden');
        });
      }
    });

    if (customTimerBtn) {
      customTimerBtn.addEventListener('click', () => {
        resetTimerPresets();
        customTimerBtn.classList.add('active');
        customTimerInput.classList.remove('hidden');
        customMinutesInput.focus();
      });
    }

    if (setCustomTimer) {
      setCustomTimer.addEventListener('click', () => {
        const minutes = parseInt(customMinutesInput.value);
        if (minutes >= 1 && minutes <= 180) {
          setSleepTimer(minutes);
          customTimerInput.classList.add('hidden');
          resetTimerPresets();
          customTimerBtn.classList.add('active');
        } else {
          alert('Masukkan waktu antara 1 dan 180 menit.');
        }
      });
    }

    if (clearTimer) {
      clearTimer.addEventListener('click', () => {
        setSleepTimer(0);
        customTimerInput.classList.add('hidden');
        resetTimerPresets();
      });
    }

    window.addEventListener('mousemove', handleMouseMove);

    document.addEventListener('DOMContentLoaded', () => {
      try {
        initParticles();
        preloadAllLyrics();
        loadAlbums();
      } catch (error) {
        console.error('Error saat inisialisasi:', error);
      }
    });
  </script>
</body>
</html>